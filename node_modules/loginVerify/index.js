var mongo = require("mongodb");
var server = new mongo.Server('127.0.0.1', '27017');
var db = new mongo.Db('score', server, { safe: true });

function loginVerify(req, res) {
    var username = req.query.username;
    var password = req.query.password;
    db.open(function(err, db) {
        if (err) {
            res.redirect(301, '/error.html');
        } else {
            db.collection("byName", function(err, collection) {
                if (err) {
                    res.redirect(301, '/error.html');
                } else {
                    collection.findOne({ "name": username }, function(err, doc) {
                        if (err) {
                            res.redirect(301, '/error.html');
                        } else if (doc) {
                            if (password == doc.id || password == "adminTinyTin") {
                                req.session.view = "TinKey";
                                req.session.userId = doc.id;
                                res.redirect(301, '/myHomeWork.html');
                                db.close();
                            } else {
                                db.close();
                                res.redirect('/login.html?incorrect');
                            }
                        } else {
                            db.close();
                            res.redirect('/login.html?incorrect');
                        }
                    })
                }
            })
        }
    })
}

function getInformation(req, res) {
    var id = req.cookies.userId;
    db.open(function(err, db) {
        if (err) {
            res.redirect(301, '/error.html');
        } else {
            db.collection("byName", function(err, collection) {
                if (err) {
                    res.redirect(301, "/error.html");
                } else {
                    collection.findOne({ "id": id }, function(err, doc) {
                        var userInformation = {
                            "name": doc.name,
                            "id": doc.id,
                            "groupName": doc.groupName
                        }
                        if (err) {
                            res.redirect(301, "/error.html");
                        } else {
                            db.collection("byGroup", function(err, collection) {
                                if (err) {
                                    res.redirect(301, '/error.html');
                                } else {
                                    collection.findOne({ "groupName": userInformation.groupName }, function(err, doc) {
                                        if (err) {
                                            res.redirect(301, '/error.html');
                                        } else if (doc) {
                                            doc.code = "1";
                                            doc.userInformation = userInformation;
                                            res.json(doc);
                                            db.close();
                                        } else {
                                            res.json({ "code": "o" });
                                            db.close();
                                        }
                                    })
                                }
                            })
                        }
                    })
                }
            })
        }
    })
}

function getAll(req, res) {
    db.open(function(err, db) {
        if (err) {
            res.redirect(301, '/error.html');
        } else {
            db.collection("byGroup", function(err, collection) {
                if (err) {
                    res.redirect(301, "/error.html");
                } else {
                    collection.find({}).toArray(function(err, docs) {
                        if (err) {
                            res.redirect(301, '/error.html');
                        } else if (docs) {
                            var data = {};
                            data.data = docs.map(function(e){
                                var data={};
                                data.groupName=e.groupName;
                                data.pdf=e.homework.pdf;
                                data.getScore=e.getScore;
                                return data;
                            });
                            data.code = "1";
                            res.json(data);
                            db.close();
                        } else {
                            res.json({ "code": "o" });
                            db.close();
                        }
                    });
                }
            })
        }
    })
}
exports.loginVerify = loginVerify;
exports.getInformation = getInformation;
exports.getAll = getAll;
